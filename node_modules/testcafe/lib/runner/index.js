'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _mapReverse = require('map-reverse');

var _mapReverse2 = _interopRequireDefault(_mapReverse);

var _events = require('events');

var _lodash = require('lodash');

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _reporter = require('../reporter');

var _reporter2 = _interopRequireDefault(_reporter);

var _task = require('./task');

var _task2 = _interopRequireDefault(_task);

var _runtime = require('../errors/runtime');

var _types = require('../errors/types');

var _typeAssertions = require('../errors/runtime/type-assertions');

var _utils = require('../errors/test-run/utils');

var _detectFfmpeg = require('../utils/detect-ffmpeg');

var _detectFfmpeg2 = _interopRequireDefault(_detectFfmpeg);

var _checkFilePath = require('../utils/check-file-path');

var _checkFilePath2 = _interopRequireDefault(_checkFilePath);

var _handleErrors = require('../utils/handle-errors');

var _optionNames = require('../configuration/option-names');

var _optionNames2 = _interopRequireDefault(_optionNames);

var _flagList = require('../utils/flag-list');

var _flagList2 = _interopRequireDefault(_flagList);

var _prepareReporters = require('../utils/prepare-reporters');

var _prepareReporters2 = _interopRequireDefault(_prepareReporters);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:runner');

class Runner extends _events.EventEmitter {
    constructor(proxy, browserConnectionGateway, configuration) {
        super();

        this.proxy = proxy;
        this.bootstrapper = this._createBootstrapper(browserConnectionGateway);
        this.pendingTaskPromises = [];
        this.configuration = configuration;
        this.isCli = false;

        this.apiMethodWasCalled = new _flagList2.default({
            initialFlagValue: false,
            flags: [_optionNames2.default.src, _optionNames2.default.browsers, _optionNames2.default.reporter]
        });
    }

    _createBootstrapper(browserConnectionGateway) {
        return new _bootstrapper2.default(browserConnectionGateway);
    }

    _disposeBrowserSet(browserSet) {
        return browserSet.dispose().catch(e => DEBUG_LOGGER(e));
    }

    _disposeReporters(reporters) {
        return _pinkie2.default.all(reporters.map(reporter => reporter.dispose().catch(e => DEBUG_LOGGER(e))));
    }

    _disposeTestedApp(testedApp) {
        return testedApp ? testedApp.kill().catch(e => DEBUG_LOGGER(e)) : _pinkie2.default.resolve();
    }

    _disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.abort();
            task.clearListeners();

            yield _this._disposeAssets(browserSet, reporters, testedApp);
        })();
    }

    _disposeAssets(browserSet, reporters, testedApp) {
        return _pinkie2.default.all([this._disposeBrowserSet(browserSet), this._disposeReporters(reporters), this._disposeTestedApp(testedApp)]);
    }

    _prepareArrayParameter(array) {
        array = (0, _lodash.flattenDeep)(array);

        if (this.isCli) return array.length === 0 ? void 0 : array;

        return array;
    }

    _createCancelablePromise(taskPromise) {
        const promise = taskPromise.then(({ completionPromise }) => completionPromise);
        const removeFromPending = () => (0, _lodash.pull)(this.pendingTaskPromises, promise);

        promise.then(removeFromPending).catch(removeFromPending);

        promise.cancel = () => taskPromise.then(({ cancelTask }) => cancelTask()).then(removeFromPending);

        this.pendingTaskPromises.push(promise);
        return promise;
    }

    // Run task
    _getFailedTestCount(task, reporter) {
        let failedTestCount = reporter.testCount - reporter.passed;

        if (task.opts.stopOnFirstFail && !!failedTestCount) failedTestCount = 1;

        return failedTestCount;
    }

    _getTaskResult(task, browserSet, reporters, testedApp) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.on('browser-job-done', function (job) {
                return browserSet.releaseConnection(job.browserConnection);
            });

            const browserSetErrorPromise = (0, _promisifyEvent2.default)(browserSet, 'error');

            const taskDonePromise = task.once('done').then(function () {
                return browserSetErrorPromise.cancel();
            });

            const promises = [taskDonePromise, browserSetErrorPromise];

            if (testedApp) promises.push(testedApp.errorPromise);

            try {
                yield _pinkie2.default.race(promises);
            } catch (err) {
                yield _this2._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);

                throw err;
            }

            yield _this2._disposeAssets(browserSet, reporters, testedApp);

            return _this2._getFailedTestCount(task, reporters[0]);
        })();
    }

    _createTask(tests, browserConnectionGroups, proxy, opts) {
        return new _task2.default(tests, browserConnectionGroups, proxy, opts);
    }

    _runTask(reporterPlugins, browserSet, tests, testedApp) {
        var _this3 = this;

        let completed = false;
        const task = this._createTask(tests, browserSet.browserConnectionGroups, this.proxy, this.configuration.getOptions());
        const reporters = reporterPlugins.map(reporter => new _reporter2.default(reporter.plugin, task, reporter.outStream));
        const completionPromise = this._getTaskResult(task, browserSet, reporters, testedApp);

        task.on('start', _handleErrors.startHandlingTestErrors);

        if (!this.configuration.getOption(_optionNames2.default.skipUncaughtErrors)) {
            task.once('test-run-start', _handleErrors.addRunningTest);
            task.once('test-run-done', _handleErrors.removeRunningTest);
        }

        task.on('done', _handleErrors.stopHandlingTestErrors);

        const setCompleted = () => {
            completed = true;
        };

        completionPromise.then(setCompleted).catch(setCompleted);

        const cancelTask = (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* () {
                if (!completed) yield _this3._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);
            });

            return function cancelTask() {
                return _ref.apply(this, arguments);
            };
        })();

        return { completionPromise, cancelTask };
    }

    _registerAssets(assets) {
        assets.forEach(asset => this.proxy.GET(asset.path, asset.info));
    }

    _validateSpeedOption() {
        const speed = this.configuration.getOption(_optionNames2.default.speed);

        if (speed === void 0) return;

        if (typeof speed !== 'number' || isNaN(speed) || speed < 0.01 || speed > 1) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.invalidSpeedValue);
    }

    _validateConcurrencyOption() {
        const concurrency = this.configuration.getOption(_optionNames2.default.concurrency);

        if (concurrency === void 0) return;

        if (typeof concurrency !== 'number' || isNaN(concurrency) || concurrency < 1) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.invalidConcurrencyFactor);
    }

    _validateProxyBypassOption() {
        let proxyBypass = this.configuration.getOption(_optionNames2.default.proxyBypass);

        if (proxyBypass === void 0) return;

        (0, _typeAssertions.assertType)([_typeAssertions.is.string, _typeAssertions.is.array], null, '"proxyBypass" argument', proxyBypass);

        if (typeof proxyBypass === 'string') proxyBypass = [proxyBypass];

        proxyBypass = proxyBypass.reduce((arr, rules) => {
            (0, _typeAssertions.assertType)(_typeAssertions.is.string, null, '"proxyBypass" argument', rules);

            return arr.concat(rules.split(','));
        }, []);

        this.configuration.mergeOptions({ proxyBypass });
    }

    _validateScreenshotOptions() {
        const screenshotPath = this.configuration.getOption(_optionNames2.default.screenshotPath);
        const screenshotPathPattern = this.configuration.getOption(_optionNames2.default.screenshotPathPattern);

        if (screenshotPath) {
            this._validateScreenshotPath(screenshotPath, 'screenshots base directory path');

            this.configuration.mergeOptions({ [_optionNames2.default.screenshotPath]: (0, _path.resolve)(screenshotPath) });
        }

        if (screenshotPathPattern) this._validateScreenshotPath(screenshotPathPattern, 'screenshots path pattern');

        if (!screenshotPath && screenshotPathPattern) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotUseScreenshotPathPatternWithoutBaseScreenshotPathSpecified);
    }

    _validateVideoOptions() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const videoPath = _this4.configuration.getOption(_optionNames2.default.videoPath);
            const videoEncodingOptions = _this4.configuration.getOption(_optionNames2.default.videoEncodingOptions);

            let videoOptions = _this4.configuration.getOption(_optionNames2.default.videoOptions);

            if (!videoPath) {
                if (videoOptions || videoEncodingOptions) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotSetVideoOptionsWithoutBaseVideoPathSpecified);

                return;
            }

            _this4.configuration.mergeOptions({ [_optionNames2.default.videoPath]: (0, _path.resolve)(videoPath) });

            if (!videoOptions) {
                videoOptions = {};

                _this4.configuration.mergeOptions({ [_optionNames2.default.videoOptions]: videoOptions });
            }

            if (videoOptions.ffmpegPath) videoOptions.ffmpegPath = (0, _path.resolve)(videoOptions.ffmpegPath);else videoOptions.ffmpegPath = yield (0, _detectFfmpeg2.default)();

            if (!videoOptions.ffmpegPath) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotFindFFMPEG);
        })();
    }

    _validateRunOptions() {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this5._validateScreenshotOptions();
            yield _this5._validateVideoOptions();
            _this5._validateSpeedOption();
            _this5._validateConcurrencyOption();
            _this5._validateProxyBypassOption();
        })();
    }

    _createRunnableConfiguration() {
        return this.bootstrapper.createRunnableConfiguration().then(runnableConfiguration => {
            this.emit('done-bootstrapping');

            return runnableConfiguration;
        });
    }

    _validateScreenshotPath(screenshotPath, pathType) {
        const forbiddenCharsList = (0, _checkFilePath2.default)(screenshotPath);

        if (forbiddenCharsList.length) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.forbiddenCharatersInScreenshotPath, screenshotPath, pathType, (0, _utils.renderForbiddenCharsList)(forbiddenCharsList));
    }

    _setBootstrapperOptions() {
        this.configuration.prepare();
        this.configuration.notifyAboutOverridenOptions();

        this.bootstrapper.sources = this.configuration.getOption(_optionNames2.default.src) || this.bootstrapper.sources;
        this.bootstrapper.browsers = this.configuration.getOption(_optionNames2.default.browsers) || this.bootstrapper.browsers;
        this.bootstrapper.concurrency = this.configuration.getOption(_optionNames2.default.concurrency);
        this.bootstrapper.appCommand = this.configuration.getOption(_optionNames2.default.appCommand) || this.bootstrapper.appCommand;
        this.bootstrapper.appInitDelay = this.configuration.getOption(_optionNames2.default.appInitDelay);
        this.bootstrapper.filter = this.configuration.getOption(_optionNames2.default.filter) || this.bootstrapper.filter;
        this.bootstrapper.reporters = this.configuration.getOption(_optionNames2.default.reporter) || this.bootstrapper.reporters;
    }

    // API
    embeddingOptions(opts) {
        const assets = opts.assets,
              TestRunCtor = opts.TestRunCtor;


        this._registerAssets(assets);
        this.configuration.mergeOptions({ TestRunCtor });

        return this;
    }

    src(...sources) {
        if (this.apiMethodWasCalled.src) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.multipleAPIMethodCallForbidden, _optionNames2.default.src);

        sources = this._prepareArrayParameter(sources);
        this.configuration.mergeOptions({ [_optionNames2.default.src]: sources });

        this.apiMethodWasCalled.src = true;

        return this;
    }

    browsers(...browsers) {
        if (this.apiMethodWasCalled.browsers) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.multipleAPIMethodCallForbidden, _optionNames2.default.browsers);

        browsers = this._prepareArrayParameter(browsers);
        this.configuration.mergeOptions({ browsers });

        this.apiMethodWasCalled.browsers = true;

        return this;
    }

    concurrency(concurrency) {
        this.configuration.mergeOptions({ concurrency });

        return this;
    }

    reporter(name, output) {
        if (this.apiMethodWasCalled.reporter) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.multipleAPIMethodCallForbidden, _optionNames2.default.reporter);

        let reporters = (0, _prepareReporters2.default)(name, output);

        reporters = this._prepareArrayParameter(reporters);

        this.configuration.mergeOptions({ [_optionNames2.default.reporter]: reporters });

        this.apiMethodWasCalled.reporter = true;

        return this;
    }

    filter(filter) {
        this.configuration.mergeOptions({ filter });

        return this;
    }

    useProxy(proxy, proxyBypass) {
        this.configuration.mergeOptions({ proxy, proxyBypass });

        return this;
    }

    screenshots(path, takeOnFails, pattern) {
        this.configuration.mergeOptions({
            [_optionNames2.default.screenshotPath]: path,
            [_optionNames2.default.takeScreenshotsOnFails]: takeOnFails,
            [_optionNames2.default.screenshotPathPattern]: pattern
        });

        return this;
    }

    video(path, options, encodingOptions) {
        this.configuration.mergeOptions({
            [_optionNames2.default.videoPath]: path,
            [_optionNames2.default.videoOptions]: options,
            [_optionNames2.default.videoEncodingOptions]: encodingOptions
        });

        return this;
    }

    startApp(command, initDelay) {
        this.configuration.mergeOptions({
            [_optionNames2.default.appCommand]: command,
            [_optionNames2.default.appInitDelay]: initDelay
        });

        return this;
    }

    run(options = {}) {
        this.apiMethodWasCalled.reset();

        const skipJsErrors = options.skipJsErrors,
              disablePageReloads = options.disablePageReloads,
              quarantineMode = options.quarantineMode,
              debugMode = options.debugMode,
              selectorTimeout = options.selectorTimeout,
              assertionTimeout = options.assertionTimeout,
              pageLoadTimeout = options.pageLoadTimeout,
              speed = options.speed,
              debugOnFail = options.debugOnFail,
              skipUncaughtErrors = options.skipUncaughtErrors,
              stopOnFirstFail = options.stopOnFirstFail;


        this.configuration.mergeOptions({
            skipJsErrors: skipJsErrors,
            disablePageReloads: disablePageReloads,
            quarantineMode: quarantineMode,
            debugMode: debugMode,
            debugOnFail: debugOnFail,
            selectorTimeout: selectorTimeout,
            assertionTimeout: assertionTimeout,
            pageLoadTimeout: pageLoadTimeout,
            speed: speed,
            skipUncaughtErrors: skipUncaughtErrors,
            stopOnFirstFail: stopOnFirstFail
        });

        this._setBootstrapperOptions();

        const runTaskPromise = _pinkie2.default.resolve().then(() => this._validateRunOptions()).then(() => this._createRunnableConfiguration()).then(({ reporterPlugins, browserSet, tests, testedApp }) => {
            return this._runTask(reporterPlugins, browserSet, tests, testedApp);
        });

        return this._createCancelablePromise(runTaskPromise);
    }

    stop() {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            // NOTE: When taskPromise is cancelled, it is removed from
            // the pendingTaskPromises array, which leads to shifting indexes
            // towards the beginning. So, we must copy the array in order to iterate it,
            // or we can perform iteration from the end to the beginning.
            const cancellationPromises = (0, _mapReverse2.default)(_this6.pendingTaskPromises, function (taskPromise) {
                return taskPromise.cancel();
            });

            yield _pinkie2.default.all(cancellationPromises);
        })();
    }
}
exports.default = Runner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvaW5kZXguanMiXSwibmFtZXMiOlsiREVCVUdfTE9HR0VSIiwiUnVubmVyIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJwcm94eSIsImJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSIsImNvbmZpZ3VyYXRpb24iLCJib290c3RyYXBwZXIiLCJfY3JlYXRlQm9vdHN0cmFwcGVyIiwicGVuZGluZ1Rhc2tQcm9taXNlcyIsImlzQ2xpIiwiYXBpTWV0aG9kV2FzQ2FsbGVkIiwiRmxhZ0xpc3QiLCJpbml0aWFsRmxhZ1ZhbHVlIiwiZmxhZ3MiLCJPUFRJT05fTkFNRVMiLCJzcmMiLCJicm93c2VycyIsInJlcG9ydGVyIiwiQm9vdHN0cmFwcGVyIiwiX2Rpc3Bvc2VCcm93c2VyU2V0IiwiYnJvd3NlclNldCIsImRpc3Bvc2UiLCJjYXRjaCIsImUiLCJfZGlzcG9zZVJlcG9ydGVycyIsInJlcG9ydGVycyIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJfZGlzcG9zZVRlc3RlZEFwcCIsInRlc3RlZEFwcCIsImtpbGwiLCJyZXNvbHZlIiwiX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyIsInRhc2siLCJhYm9ydCIsImNsZWFyTGlzdGVuZXJzIiwiX2Rpc3Bvc2VBc3NldHMiLCJfcHJlcGFyZUFycmF5UGFyYW1ldGVyIiwiYXJyYXkiLCJsZW5ndGgiLCJfY3JlYXRlQ2FuY2VsYWJsZVByb21pc2UiLCJ0YXNrUHJvbWlzZSIsInByb21pc2UiLCJ0aGVuIiwiY29tcGxldGlvblByb21pc2UiLCJyZW1vdmVGcm9tUGVuZGluZyIsImNhbmNlbCIsImNhbmNlbFRhc2siLCJwdXNoIiwiX2dldEZhaWxlZFRlc3RDb3VudCIsImZhaWxlZFRlc3RDb3VudCIsInRlc3RDb3VudCIsInBhc3NlZCIsIm9wdHMiLCJzdG9wT25GaXJzdEZhaWwiLCJfZ2V0VGFza1Jlc3VsdCIsIm9uIiwicmVsZWFzZUNvbm5lY3Rpb24iLCJqb2IiLCJicm93c2VyQ29ubmVjdGlvbiIsImJyb3dzZXJTZXRFcnJvclByb21pc2UiLCJ0YXNrRG9uZVByb21pc2UiLCJvbmNlIiwicHJvbWlzZXMiLCJlcnJvclByb21pc2UiLCJyYWNlIiwiZXJyIiwiX2NyZWF0ZVRhc2siLCJ0ZXN0cyIsImJyb3dzZXJDb25uZWN0aW9uR3JvdXBzIiwiVGFzayIsIl9ydW5UYXNrIiwicmVwb3J0ZXJQbHVnaW5zIiwiY29tcGxldGVkIiwiZ2V0T3B0aW9ucyIsIlJlcG9ydGVyIiwicGx1Z2luIiwib3V0U3RyZWFtIiwic3RhcnRIYW5kbGluZ1Rlc3RFcnJvcnMiLCJnZXRPcHRpb24iLCJza2lwVW5jYXVnaHRFcnJvcnMiLCJhZGRSdW5uaW5nVGVzdCIsInJlbW92ZVJ1bm5pbmdUZXN0Iiwic3RvcEhhbmRsaW5nVGVzdEVycm9ycyIsInNldENvbXBsZXRlZCIsIl9yZWdpc3RlckFzc2V0cyIsImFzc2V0cyIsImZvckVhY2giLCJhc3NldCIsIkdFVCIsInBhdGgiLCJpbmZvIiwiX3ZhbGlkYXRlU3BlZWRPcHRpb24iLCJzcGVlZCIsImlzTmFOIiwiR2VuZXJhbEVycm9yIiwiUlVOVElNRV9FUlJPUlMiLCJpbnZhbGlkU3BlZWRWYWx1ZSIsIl92YWxpZGF0ZUNvbmN1cnJlbmN5T3B0aW9uIiwiY29uY3VycmVuY3kiLCJpbnZhbGlkQ29uY3VycmVuY3lGYWN0b3IiLCJfdmFsaWRhdGVQcm94eUJ5cGFzc09wdGlvbiIsInByb3h5QnlwYXNzIiwiaXMiLCJzdHJpbmciLCJyZWR1Y2UiLCJhcnIiLCJydWxlcyIsImNvbmNhdCIsInNwbGl0IiwibWVyZ2VPcHRpb25zIiwiX3ZhbGlkYXRlU2NyZWVuc2hvdE9wdGlvbnMiLCJzY3JlZW5zaG90UGF0aCIsInNjcmVlbnNob3RQYXRoUGF0dGVybiIsIl92YWxpZGF0ZVNjcmVlbnNob3RQYXRoIiwiY2Fubm90VXNlU2NyZWVuc2hvdFBhdGhQYXR0ZXJuV2l0aG91dEJhc2VTY3JlZW5zaG90UGF0aFNwZWNpZmllZCIsIl92YWxpZGF0ZVZpZGVvT3B0aW9ucyIsInZpZGVvUGF0aCIsInZpZGVvRW5jb2RpbmdPcHRpb25zIiwidmlkZW9PcHRpb25zIiwiY2Fubm90U2V0VmlkZW9PcHRpb25zV2l0aG91dEJhc2VWaWRlb1BhdGhTcGVjaWZpZWQiLCJmZm1wZWdQYXRoIiwiY2Fubm90RmluZEZGTVBFRyIsIl92YWxpZGF0ZVJ1bk9wdGlvbnMiLCJfY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwiY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwicnVubmFibGVDb25maWd1cmF0aW9uIiwiZW1pdCIsInBhdGhUeXBlIiwiZm9yYmlkZGVuQ2hhcnNMaXN0IiwiZm9yYmlkZGVuQ2hhcmF0ZXJzSW5TY3JlZW5zaG90UGF0aCIsIl9zZXRCb290c3RyYXBwZXJPcHRpb25zIiwicHJlcGFyZSIsIm5vdGlmeUFib3V0T3ZlcnJpZGVuT3B0aW9ucyIsInNvdXJjZXMiLCJhcHBDb21tYW5kIiwiYXBwSW5pdERlbGF5IiwiZmlsdGVyIiwiZW1iZWRkaW5nT3B0aW9ucyIsIlRlc3RSdW5DdG9yIiwibXVsdGlwbGVBUElNZXRob2RDYWxsRm9yYmlkZGVuIiwibmFtZSIsIm91dHB1dCIsInVzZVByb3h5Iiwic2NyZWVuc2hvdHMiLCJ0YWtlT25GYWlscyIsInBhdHRlcm4iLCJ0YWtlU2NyZWVuc2hvdHNPbkZhaWxzIiwidmlkZW8iLCJvcHRpb25zIiwiZW5jb2RpbmdPcHRpb25zIiwic3RhcnRBcHAiLCJjb21tYW5kIiwiaW5pdERlbGF5IiwicnVuIiwicmVzZXQiLCJza2lwSnNFcnJvcnMiLCJkaXNhYmxlUGFnZVJlbG9hZHMiLCJxdWFyYW50aW5lTW9kZSIsImRlYnVnTW9kZSIsInNlbGVjdG9yVGltZW91dCIsImFzc2VydGlvblRpbWVvdXQiLCJwYWdlTG9hZFRpbWVvdXQiLCJkZWJ1Z09uRmFpbCIsInJ1blRhc2tQcm9taXNlIiwic3RvcCIsImNhbmNlbGxhdGlvblByb21pc2VzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7Ozs7QUFD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RlE7QUFHNUJDLDRCQUFvQkEsY0FIUTtBQUk1QkMsdUJBQW9CQSxTQUpRO0FBSzVCSSx5QkFBb0JBLFdBTFE7QUFNNUJILDZCQUFvQkEsZUFOUTtBQU81QkMsOEJBQW9CQSxnQkFQUTtBQVE1QkMsNkJBQW9CQSxlQVJRO0FBUzVCckUsbUJBQW9CQSxLQVRRO0FBVTVCYixnQ0FBb0JBLGtCQVZRO0FBVzVCMUIsNkJBQW9CQTtBQVhRLFNBQWhDOztBQWNBLGFBQUs2RSx1QkFBTDs7QUFFQSxjQUFNaUMsaUJBQWlCM0ksaUJBQVFNLE9BQVIsR0FDbEJZLElBRGtCLENBQ2IsTUFBTSxLQUFLZ0YsbUJBQUwsRUFETyxFQUVsQmhGLElBRmtCLENBRWIsTUFBTSxLQUFLaUYsNEJBQUwsRUFGTyxFQUdsQmpGLElBSGtCLENBR2IsQ0FBQyxFQUFFNkIsZUFBRixFQUFtQnJELFVBQW5CLEVBQStCaUQsS0FBL0IsRUFBc0N2QyxTQUF0QyxFQUFELEtBQXVEO0FBQ3pELG1CQUFPLEtBQUswQyxRQUFMLENBQWNDLGVBQWQsRUFBK0JyRCxVQUEvQixFQUEyQ2lELEtBQTNDLEVBQWtEdkMsU0FBbEQsQ0FBUDtBQUNILFNBTGtCLENBQXZCOztBQU9BLGVBQU8sS0FBS1csd0JBQUwsQ0FBOEI0SCxjQUE5QixDQUFQO0FBQ0g7O0FBRUtDLFFBQU4sR0FBYztBQUFBOztBQUFBO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrQkFBTUMsdUJBQXVCLDBCQUFXLE9BQUsvSixtQkFBaEIsRUFBcUM7QUFBQSx1QkFBZWtDLFlBQVlLLE1BQVosRUFBZjtBQUFBLGFBQXJDLENBQTdCOztBQUVBLGtCQUFNckIsaUJBQVFDLEdBQVIsQ0FBWTRJLG9CQUFaLENBQU47QUFQVTtBQVFiO0FBeGE0QztrQkFBNUJ2SyxNIiwiZmlsZSI6InJ1bm5lci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlc29sdmUgYXMgcmVzb2x2ZVBhdGggfSBmcm9tICdwYXRoJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHByb21pc2lmeUV2ZW50IGZyb20gJ3Byb21pc2lmeS1ldmVudCc7XG5pbXBvcnQgbWFwUmV2ZXJzZSBmcm9tICdtYXAtcmV2ZXJzZSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgZmxhdHRlbkRlZXAgYXMgZmxhdHRlbiwgcHVsbCBhcyByZW1vdmUgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEJvb3RzdHJhcHBlciBmcm9tICcuL2Jvb3RzdHJhcHBlcic7XG5pbXBvcnQgUmVwb3J0ZXIgZnJvbSAnLi4vcmVwb3J0ZXInO1xuaW1wb3J0IFRhc2sgZnJvbSAnLi90YXNrJztcbmltcG9ydCB7IEdlbmVyYWxFcnJvciB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCB7IFJVTlRJTUVfRVJST1JTIH0gZnJvbSAnLi4vZXJyb3JzL3R5cGVzJztcbmltcG9ydCB7IGFzc2VydFR5cGUsIGlzIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvdHlwZS1hc3NlcnRpb25zJztcbmltcG9ydCB7IHJlbmRlckZvcmJpZGRlbkNoYXJzTGlzdCB9IGZyb20gJy4uL2Vycm9ycy90ZXN0LXJ1bi91dGlscyc7XG5pbXBvcnQgZGV0ZWN0RkZNUEVHIGZyb20gJy4uL3V0aWxzL2RldGVjdC1mZm1wZWcnO1xuaW1wb3J0IGNoZWNrRmlsZVBhdGggZnJvbSAnLi4vdXRpbHMvY2hlY2stZmlsZS1wYXRoJztcbmltcG9ydCB7IGFkZFJ1bm5pbmdUZXN0LCByZW1vdmVSdW5uaW5nVGVzdCwgc3RhcnRIYW5kbGluZ1Rlc3RFcnJvcnMsIHN0b3BIYW5kbGluZ1Rlc3RFcnJvcnMgfSBmcm9tICcuLi91dGlscy9oYW5kbGUtZXJyb3JzJztcbmltcG9ydCBPUFRJT05fTkFNRVMgZnJvbSAnLi4vY29uZmlndXJhdGlvbi9vcHRpb24tbmFtZXMnO1xuaW1wb3J0IEZsYWdMaXN0IGZyb20gJy4uL3V0aWxzL2ZsYWctbGlzdCc7XG5pbXBvcnQgcHJlcGFyZVJlcG9ydGVycyBmcm9tICcuLi91dGlscy9wcmVwYXJlLXJlcG9ydGVycyc7XG5cbmNvbnN0IERFQlVHX0xPR0dFUiA9IGRlYnVnKCd0ZXN0Y2FmZTpydW5uZXInKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUnVubmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAocHJveHksIGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSwgY29uZmlndXJhdGlvbikge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMucHJveHkgICAgICAgICAgICAgICA9IHByb3h5O1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlciAgICAgICAgPSB0aGlzLl9jcmVhdGVCb290c3RyYXBwZXIoYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KTtcbiAgICAgICAgdGhpcy5wZW5kaW5nVGFza1Byb21pc2VzID0gW107XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbiAgICAgICA9IGNvbmZpZ3VyYXRpb247XG4gICAgICAgIHRoaXMuaXNDbGkgICAgICAgICAgICAgICA9IGZhbHNlO1xuXG4gICAgICAgIHRoaXMuYXBpTWV0aG9kV2FzQ2FsbGVkID0gbmV3IEZsYWdMaXN0KHtcbiAgICAgICAgICAgIGluaXRpYWxGbGFnVmFsdWU6IGZhbHNlLFxuICAgICAgICAgICAgZmxhZ3M6ICAgICAgICAgICAgW09QVElPTl9OQU1FUy5zcmMsIE9QVElPTl9OQU1FUy5icm93c2VycywgT1BUSU9OX05BTUVTLnJlcG9ydGVyXVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfY3JlYXRlQm9vdHN0cmFwcGVyIChicm93c2VyQ29ubmVjdGlvbkdhdGV3YXkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBCb290c3RyYXBwZXIoYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KTtcbiAgICB9XG5cbiAgICBfZGlzcG9zZUJyb3dzZXJTZXQgKGJyb3dzZXJTZXQpIHtcbiAgICAgICAgcmV0dXJuIGJyb3dzZXJTZXQuZGlzcG9zZSgpLmNhdGNoKGUgPT4gREVCVUdfTE9HR0VSKGUpKTtcbiAgICB9XG5cbiAgICBfZGlzcG9zZVJlcG9ydGVycyAocmVwb3J0ZXJzKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChyZXBvcnRlcnMubWFwKHJlcG9ydGVyID0+IHJlcG9ydGVyLmRpc3Bvc2UoKS5jYXRjaChlID0+IERFQlVHX0xPR0dFUihlKSkpKTtcbiAgICB9XG5cbiAgICBfZGlzcG9zZVRlc3RlZEFwcCAodGVzdGVkQXBwKSB7XG4gICAgICAgIHJldHVybiB0ZXN0ZWRBcHAgPyB0ZXN0ZWRBcHAua2lsbCgpLmNhdGNoKGUgPT4gREVCVUdfTE9HR0VSKGUpKSA6IFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9kaXNwb3NlVGFza0FuZFJlbGF0ZWRBc3NldHMgKHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKSB7XG4gICAgICAgIHRhc2suYWJvcnQoKTtcbiAgICAgICAgdGFzay5jbGVhckxpc3RlbmVycygpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuX2Rpc3Bvc2VBc3NldHMoYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApO1xuICAgIH1cblxuICAgIF9kaXNwb3NlQXNzZXRzIChicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgdGhpcy5fZGlzcG9zZUJyb3dzZXJTZXQoYnJvd3NlclNldCksXG4gICAgICAgICAgICB0aGlzLl9kaXNwb3NlUmVwb3J0ZXJzKHJlcG9ydGVycyksXG4gICAgICAgICAgICB0aGlzLl9kaXNwb3NlVGVzdGVkQXBwKHRlc3RlZEFwcClcbiAgICAgICAgXSk7XG4gICAgfVxuXG4gICAgX3ByZXBhcmVBcnJheVBhcmFtZXRlciAoYXJyYXkpIHtcbiAgICAgICAgYXJyYXkgPSBmbGF0dGVuKGFycmF5KTtcblxuICAgICAgICBpZiAodGhpcy5pc0NsaSlcbiAgICAgICAgICAgIHJldHVybiBhcnJheS5sZW5ndGggPT09IDAgPyB2b2lkIDAgOiBhcnJheTtcblxuICAgICAgICByZXR1cm4gYXJyYXk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlICh0YXNrUHJvbWlzZSkge1xuICAgICAgICBjb25zdCBwcm9taXNlICAgICAgICAgICA9IHRhc2tQcm9taXNlLnRoZW4oKHsgY29tcGxldGlvblByb21pc2UgfSkgPT4gY29tcGxldGlvblByb21pc2UpO1xuICAgICAgICBjb25zdCByZW1vdmVGcm9tUGVuZGluZyA9ICgpID0+IHJlbW92ZSh0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMsIHByb21pc2UpO1xuXG4gICAgICAgIHByb21pc2VcbiAgICAgICAgICAgIC50aGVuKHJlbW92ZUZyb21QZW5kaW5nKVxuICAgICAgICAgICAgLmNhdGNoKHJlbW92ZUZyb21QZW5kaW5nKTtcblxuICAgICAgICBwcm9taXNlLmNhbmNlbCA9ICgpID0+IHRhc2tQcm9taXNlXG4gICAgICAgICAgICAudGhlbigoeyBjYW5jZWxUYXNrIH0pID0+IGNhbmNlbFRhc2soKSlcbiAgICAgICAgICAgIC50aGVuKHJlbW92ZUZyb21QZW5kaW5nKTtcblxuICAgICAgICB0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMucHVzaChwcm9taXNlKTtcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfVxuXG4gICAgLy8gUnVuIHRhc2tcbiAgICBfZ2V0RmFpbGVkVGVzdENvdW50ICh0YXNrLCByZXBvcnRlcikge1xuICAgICAgICBsZXQgZmFpbGVkVGVzdENvdW50ID0gcmVwb3J0ZXIudGVzdENvdW50IC0gcmVwb3J0ZXIucGFzc2VkO1xuXG4gICAgICAgIGlmICh0YXNrLm9wdHMuc3RvcE9uRmlyc3RGYWlsICYmICEhZmFpbGVkVGVzdENvdW50KVxuICAgICAgICAgICAgZmFpbGVkVGVzdENvdW50ID0gMTtcblxuICAgICAgICByZXR1cm4gZmFpbGVkVGVzdENvdW50O1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRUYXNrUmVzdWx0ICh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCkge1xuICAgICAgICB0YXNrLm9uKCdicm93c2VyLWpvYi1kb25lJywgam9iID0+IGJyb3dzZXJTZXQucmVsZWFzZUNvbm5lY3Rpb24oam9iLmJyb3dzZXJDb25uZWN0aW9uKSk7XG5cbiAgICAgICAgY29uc3QgYnJvd3NlclNldEVycm9yUHJvbWlzZSA9IHByb21pc2lmeUV2ZW50KGJyb3dzZXJTZXQsICdlcnJvcicpO1xuXG4gICAgICAgIGNvbnN0IHRhc2tEb25lUHJvbWlzZSA9IHRhc2sub25jZSgnZG9uZScpXG4gICAgICAgICAgICAudGhlbigoKSA9PiBicm93c2VyU2V0RXJyb3JQcm9taXNlLmNhbmNlbCgpKTtcblxuXG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gW1xuICAgICAgICAgICAgdGFza0RvbmVQcm9taXNlLFxuICAgICAgICAgICAgYnJvd3NlclNldEVycm9yUHJvbWlzZVxuICAgICAgICBdO1xuXG4gICAgICAgIGlmICh0ZXN0ZWRBcHApXG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKHRlc3RlZEFwcC5lcnJvclByb21pc2UpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBQcm9taXNlLnJhY2UocHJvbWlzZXMpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCk7XG5cbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX2Rpc3Bvc2VBc3NldHMoYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRGYWlsZWRUZXN0Q291bnQodGFzaywgcmVwb3J0ZXJzWzBdKTtcbiAgICB9XG5cbiAgICBfY3JlYXRlVGFzayAodGVzdHMsIGJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLCBwcm94eSwgb3B0cykge1xuICAgICAgICByZXR1cm4gbmV3IFRhc2sodGVzdHMsIGJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLCBwcm94eSwgb3B0cyk7XG4gICAgfVxuXG4gICAgX3J1blRhc2sgKHJlcG9ydGVyUGx1Z2lucywgYnJvd3NlclNldCwgdGVzdHMsIHRlc3RlZEFwcCkge1xuICAgICAgICBsZXQgY29tcGxldGVkICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICBjb25zdCB0YXNrICAgICAgICAgICAgICA9IHRoaXMuX2NyZWF0ZVRhc2sodGVzdHMsIGJyb3dzZXJTZXQuYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMsIHRoaXMucHJveHksIHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb25zKCkpO1xuICAgICAgICBjb25zdCByZXBvcnRlcnMgICAgICAgICA9IHJlcG9ydGVyUGx1Z2lucy5tYXAocmVwb3J0ZXIgPT4gbmV3IFJlcG9ydGVyKHJlcG9ydGVyLnBsdWdpbiwgdGFzaywgcmVwb3J0ZXIub3V0U3RyZWFtKSk7XG4gICAgICAgIGNvbnN0IGNvbXBsZXRpb25Qcm9taXNlID0gdGhpcy5fZ2V0VGFza1Jlc3VsdCh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCk7XG5cbiAgICAgICAgdGFzay5vbignc3RhcnQnLCBzdGFydEhhbmRsaW5nVGVzdEVycm9ycyk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5za2lwVW5jYXVnaHRFcnJvcnMpKSB7XG4gICAgICAgICAgICB0YXNrLm9uY2UoJ3Rlc3QtcnVuLXN0YXJ0JywgYWRkUnVubmluZ1Rlc3QpO1xuICAgICAgICAgICAgdGFzay5vbmNlKCd0ZXN0LXJ1bi1kb25lJywgcmVtb3ZlUnVubmluZ1Rlc3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGFzay5vbignZG9uZScsIHN0b3BIYW5kbGluZ1Rlc3RFcnJvcnMpO1xuXG4gICAgICAgIGNvbnN0IHNldENvbXBsZXRlZCA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbXBsZXRlZCA9IHRydWU7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29tcGxldGlvblByb21pc2VcbiAgICAgICAgICAgIC50aGVuKHNldENvbXBsZXRlZClcbiAgICAgICAgICAgIC5jYXRjaChzZXRDb21wbGV0ZWQpO1xuXG4gICAgICAgIGNvbnN0IGNhbmNlbFRhc2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWNvbXBsZXRlZClcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9kaXNwb3NlVGFza0FuZFJlbGF0ZWRBc3NldHModGFzaywgYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7IGNvbXBsZXRpb25Qcm9taXNlLCBjYW5jZWxUYXNrIH07XG4gICAgfVxuXG4gICAgX3JlZ2lzdGVyQXNzZXRzIChhc3NldHMpIHtcbiAgICAgICAgYXNzZXRzLmZvckVhY2goYXNzZXQgPT4gdGhpcy5wcm94eS5HRVQoYXNzZXQucGF0aCwgYXNzZXQuaW5mbykpO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZVNwZWVkT3B0aW9uICgpIHtcbiAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5zcGVlZCk7XG5cbiAgICAgICAgaWYgKHNwZWVkID09PSB2b2lkIDApXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCAhPT0gJ251bWJlcicgfHwgaXNOYU4oc3BlZWQpIHx8IHNwZWVkIDwgMC4wMSB8fCBzcGVlZCA+IDEpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmludmFsaWRTcGVlZFZhbHVlKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVDb25jdXJyZW5jeU9wdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IGNvbmN1cnJlbmN5ID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuY29uY3VycmVuY3kpO1xuXG4gICAgICAgIGlmIChjb25jdXJyZW5jeSA9PT0gdm9pZCAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGlmICh0eXBlb2YgY29uY3VycmVuY3kgIT09ICdudW1iZXInIHx8IGlzTmFOKGNvbmN1cnJlbmN5KSB8fCBjb25jdXJyZW5jeSA8IDEpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmludmFsaWRDb25jdXJyZW5jeUZhY3Rvcik7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlUHJveHlCeXBhc3NPcHRpb24gKCkge1xuICAgICAgICBsZXQgcHJveHlCeXBhc3MgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5wcm94eUJ5cGFzcyk7XG5cbiAgICAgICAgaWYgKHByb3h5QnlwYXNzID09PSB2b2lkIDApXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgYXNzZXJ0VHlwZShbIGlzLnN0cmluZywgaXMuYXJyYXkgXSwgbnVsbCwgJ1wicHJveHlCeXBhc3NcIiBhcmd1bWVudCcsIHByb3h5QnlwYXNzKTtcblxuICAgICAgICBpZiAodHlwZW9mIHByb3h5QnlwYXNzID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgIHByb3h5QnlwYXNzID0gW3Byb3h5QnlwYXNzXTtcblxuICAgICAgICBwcm94eUJ5cGFzcyA9IHByb3h5QnlwYXNzLnJlZHVjZSgoYXJyLCBydWxlcykgPT4ge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5zdHJpbmcsIG51bGwsICdcInByb3h5QnlwYXNzXCIgYXJndW1lbnQnLCBydWxlcyk7XG5cbiAgICAgICAgICAgIHJldHVybiBhcnIuY29uY2F0KHJ1bGVzLnNwbGl0KCcsJykpO1xuICAgICAgICB9LCBbXSk7XG5cbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IHByb3h5QnlwYXNzIH0pO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZVNjcmVlbnNob3RPcHRpb25zICgpIHtcbiAgICAgICAgY29uc3Qgc2NyZWVuc2hvdFBhdGggICAgICAgID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuc2NyZWVuc2hvdFBhdGgpO1xuICAgICAgICBjb25zdCBzY3JlZW5zaG90UGF0aFBhdHRlcm4gPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5zY3JlZW5zaG90UGF0aFBhdHRlcm4pO1xuXG4gICAgICAgIGlmIChzY3JlZW5zaG90UGF0aCkge1xuICAgICAgICAgICAgdGhpcy5fdmFsaWRhdGVTY3JlZW5zaG90UGF0aChzY3JlZW5zaG90UGF0aCwgJ3NjcmVlbnNob3RzIGJhc2UgZGlyZWN0b3J5IHBhdGgnKTtcblxuICAgICAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IFtPUFRJT05fTkFNRVMuc2NyZWVuc2hvdFBhdGhdOiByZXNvbHZlUGF0aChzY3JlZW5zaG90UGF0aCkgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2NyZWVuc2hvdFBhdGhQYXR0ZXJuKVxuICAgICAgICAgICAgdGhpcy5fdmFsaWRhdGVTY3JlZW5zaG90UGF0aChzY3JlZW5zaG90UGF0aFBhdHRlcm4sICdzY3JlZW5zaG90cyBwYXRoIHBhdHRlcm4nKTtcblxuICAgICAgICBpZiAoIXNjcmVlbnNob3RQYXRoICYmIHNjcmVlbnNob3RQYXRoUGF0dGVybilcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2Fubm90VXNlU2NyZWVuc2hvdFBhdGhQYXR0ZXJuV2l0aG91dEJhc2VTY3JlZW5zaG90UGF0aFNwZWNpZmllZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3ZhbGlkYXRlVmlkZW9PcHRpb25zICgpIHtcbiAgICAgICAgY29uc3QgdmlkZW9QYXRoICAgICAgICAgICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy52aWRlb1BhdGgpO1xuICAgICAgICBjb25zdCB2aWRlb0VuY29kaW5nT3B0aW9ucyA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnZpZGVvRW5jb2RpbmdPcHRpb25zKTtcblxuICAgICAgICBsZXQgdmlkZW9PcHRpb25zID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMudmlkZW9PcHRpb25zKTtcblxuICAgICAgICBpZiAoIXZpZGVvUGF0aCkge1xuICAgICAgICAgICAgaWYgKHZpZGVvT3B0aW9ucyB8fCB2aWRlb0VuY29kaW5nT3B0aW9ucylcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNhbm5vdFNldFZpZGVvT3B0aW9uc1dpdGhvdXRCYXNlVmlkZW9QYXRoU3BlY2lmaWVkKTtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IFtPUFRJT05fTkFNRVMudmlkZW9QYXRoXTogcmVzb2x2ZVBhdGgodmlkZW9QYXRoKSB9KTtcblxuICAgICAgICBpZiAoIXZpZGVvT3B0aW9ucykge1xuICAgICAgICAgICAgdmlkZW9PcHRpb25zID0ge307XG5cbiAgICAgICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBbT1BUSU9OX05BTUVTLnZpZGVvT3B0aW9uc106IHZpZGVvT3B0aW9ucyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2aWRlb09wdGlvbnMuZmZtcGVnUGF0aClcbiAgICAgICAgICAgIHZpZGVvT3B0aW9ucy5mZm1wZWdQYXRoID0gcmVzb2x2ZVBhdGgodmlkZW9PcHRpb25zLmZmbXBlZ1BhdGgpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICB2aWRlb09wdGlvbnMuZmZtcGVnUGF0aCA9IGF3YWl0IGRldGVjdEZGTVBFRygpO1xuXG4gICAgICAgIGlmICghdmlkZW9PcHRpb25zLmZmbXBlZ1BhdGgpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNhbm5vdEZpbmRGRk1QRUcpO1xuICAgIH1cblxuICAgIGFzeW5jIF92YWxpZGF0ZVJ1bk9wdGlvbnMgKCkge1xuICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RPcHRpb25zKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX3ZhbGlkYXRlVmlkZW9PcHRpb25zKCk7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlU3BlZWRPcHRpb24oKTtcbiAgICAgICAgdGhpcy5fdmFsaWRhdGVDb25jdXJyZW5jeU9wdGlvbigpO1xuICAgICAgICB0aGlzLl92YWxpZGF0ZVByb3h5QnlwYXNzT3B0aW9uKCk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJvb3RzdHJhcHBlclxuICAgICAgICAgICAgLmNyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbigpXG4gICAgICAgICAgICAudGhlbihydW5uYWJsZUNvbmZpZ3VyYXRpb24gPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZG9uZS1ib290c3RyYXBwaW5nJyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcnVubmFibGVDb25maWd1cmF0aW9uO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlU2NyZWVuc2hvdFBhdGggKHNjcmVlbnNob3RQYXRoLCBwYXRoVHlwZSkge1xuICAgICAgICBjb25zdCBmb3JiaWRkZW5DaGFyc0xpc3QgPSBjaGVja0ZpbGVQYXRoKHNjcmVlbnNob3RQYXRoKTtcblxuICAgICAgICBpZiAoZm9yYmlkZGVuQ2hhcnNMaXN0Lmxlbmd0aClcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuZm9yYmlkZGVuQ2hhcmF0ZXJzSW5TY3JlZW5zaG90UGF0aCwgc2NyZWVuc2hvdFBhdGgsIHBhdGhUeXBlLCByZW5kZXJGb3JiaWRkZW5DaGFyc0xpc3QoZm9yYmlkZGVuQ2hhcnNMaXN0KSk7XG4gICAgfVxuXG4gICAgX3NldEJvb3RzdHJhcHBlck9wdGlvbnMgKCkge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ucHJlcGFyZSgpO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubm90aWZ5QWJvdXRPdmVycmlkZW5PcHRpb25zKCk7XG5cbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuc291cmNlcyAgICAgID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuc3JjKSB8fCB0aGlzLmJvb3RzdHJhcHBlci5zb3VyY2VzO1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5icm93c2VycyAgICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5icm93c2VycykgfHwgdGhpcy5ib290c3RyYXBwZXIuYnJvd3NlcnM7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmNvbmN1cnJlbmN5ICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLmNvbmN1cnJlbmN5KTtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuYXBwQ29tbWFuZCAgID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuYXBwQ29tbWFuZCkgfHwgdGhpcy5ib290c3RyYXBwZXIuYXBwQ29tbWFuZDtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuYXBwSW5pdERlbGF5ID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuYXBwSW5pdERlbGF5KTtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuZmlsdGVyICAgICAgID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuZmlsdGVyKSB8fCB0aGlzLmJvb3RzdHJhcHBlci5maWx0ZXI7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLnJlcG9ydGVycyAgICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnJlcG9ydGVyKSB8fCB0aGlzLmJvb3RzdHJhcHBlci5yZXBvcnRlcnM7XG4gICAgfVxuXG4gICAgLy8gQVBJXG4gICAgZW1iZWRkaW5nT3B0aW9ucyAob3B0cykge1xuICAgICAgICBjb25zdCB7IGFzc2V0cywgVGVzdFJ1bkN0b3IgfSA9IG9wdHM7XG5cbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJBc3NldHMoYXNzZXRzKTtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IFRlc3RSdW5DdG9yIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNyYyAoLi4uc291cmNlcykge1xuICAgICAgICBpZiAodGhpcy5hcGlNZXRob2RXYXNDYWxsZWQuc3JjKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5tdWx0aXBsZUFQSU1ldGhvZENhbGxGb3JiaWRkZW4sIE9QVElPTl9OQU1FUy5zcmMpO1xuXG4gICAgICAgIHNvdXJjZXMgPSB0aGlzLl9wcmVwYXJlQXJyYXlQYXJhbWV0ZXIoc291cmNlcyk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBbT1BUSU9OX05BTUVTLnNyY106IHNvdXJjZXMgfSk7XG5cbiAgICAgICAgdGhpcy5hcGlNZXRob2RXYXNDYWxsZWQuc3JjID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBicm93c2VycyAoLi4uYnJvd3NlcnMpIHtcbiAgICAgICAgaWYgKHRoaXMuYXBpTWV0aG9kV2FzQ2FsbGVkLmJyb3dzZXJzKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5tdWx0aXBsZUFQSU1ldGhvZENhbGxGb3JiaWRkZW4sIE9QVElPTl9OQU1FUy5icm93c2Vycyk7XG5cbiAgICAgICAgYnJvd3NlcnMgPSB0aGlzLl9wcmVwYXJlQXJyYXlQYXJhbWV0ZXIoYnJvd3NlcnMpO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgYnJvd3NlcnMgfSk7XG5cbiAgICAgICAgdGhpcy5hcGlNZXRob2RXYXNDYWxsZWQuYnJvd3NlcnMgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGNvbmN1cnJlbmN5IChjb25jdXJyZW5jeSkge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgY29uY3VycmVuY3kgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcmVwb3J0ZXIgKG5hbWUsIG91dHB1dCkge1xuICAgICAgICBpZiAodGhpcy5hcGlNZXRob2RXYXNDYWxsZWQucmVwb3J0ZXIpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLm11bHRpcGxlQVBJTWV0aG9kQ2FsbEZvcmJpZGRlbiwgT1BUSU9OX05BTUVTLnJlcG9ydGVyKTtcblxuICAgICAgICBsZXQgcmVwb3J0ZXJzID0gcHJlcGFyZVJlcG9ydGVycyhuYW1lLCBvdXRwdXQpO1xuXG4gICAgICAgIHJlcG9ydGVycyA9IHRoaXMuX3ByZXBhcmVBcnJheVBhcmFtZXRlcihyZXBvcnRlcnMpO1xuXG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBbT1BUSU9OX05BTUVTLnJlcG9ydGVyXTogcmVwb3J0ZXJzIH0pO1xuXG4gICAgICAgIHRoaXMuYXBpTWV0aG9kV2FzQ2FsbGVkLnJlcG9ydGVyID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBmaWx0ZXIgKGZpbHRlcikge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgZmlsdGVyIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHVzZVByb3h5IChwcm94eSwgcHJveHlCeXBhc3MpIHtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IHByb3h5LCBwcm94eUJ5cGFzcyB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzY3JlZW5zaG90cyAocGF0aCwgdGFrZU9uRmFpbHMsIHBhdHRlcm4pIHtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7XG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLnNjcmVlbnNob3RQYXRoXTogICAgICAgICBwYXRoLFxuICAgICAgICAgICAgW09QVElPTl9OQU1FUy50YWtlU2NyZWVuc2hvdHNPbkZhaWxzXTogdGFrZU9uRmFpbHMsXG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLnNjcmVlbnNob3RQYXRoUGF0dGVybl06ICBwYXR0ZXJuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHZpZGVvIChwYXRoLCBvcHRpb25zLCBlbmNvZGluZ09wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7XG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLnZpZGVvUGF0aF06ICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMudmlkZW9PcHRpb25zXTogICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgW09QVElPTl9OQU1FUy52aWRlb0VuY29kaW5nT3B0aW9uc106IGVuY29kaW5nT3B0aW9uc1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzdGFydEFwcCAoY29tbWFuZCwgaW5pdERlbGF5KSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoe1xuICAgICAgICAgICAgW09QVElPTl9OQU1FUy5hcHBDb21tYW5kXTogICBjb21tYW5kLFxuICAgICAgICAgICAgW09QVElPTl9OQU1FUy5hcHBJbml0RGVsYXldOiBpbml0RGVsYXlcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcnVuIChvcHRpb25zID0ge30pIHtcbiAgICAgICAgdGhpcy5hcGlNZXRob2RXYXNDYWxsZWQucmVzZXQoKTtcblxuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBza2lwSnNFcnJvcnMsXG4gICAgICAgICAgICBkaXNhYmxlUGFnZVJlbG9hZHMsXG4gICAgICAgICAgICBxdWFyYW50aW5lTW9kZSxcbiAgICAgICAgICAgIGRlYnVnTW9kZSxcbiAgICAgICAgICAgIHNlbGVjdG9yVGltZW91dCxcbiAgICAgICAgICAgIGFzc2VydGlvblRpbWVvdXQsXG4gICAgICAgICAgICBwYWdlTG9hZFRpbWVvdXQsXG4gICAgICAgICAgICBzcGVlZCxcbiAgICAgICAgICAgIGRlYnVnT25GYWlsLFxuICAgICAgICAgICAgc2tpcFVuY2F1Z2h0RXJyb3JzLFxuICAgICAgICAgICAgc3RvcE9uRmlyc3RGYWlsXG4gICAgICAgIH0gPSBvcHRpb25zO1xuXG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoe1xuICAgICAgICAgICAgc2tpcEpzRXJyb3JzOiAgICAgICBza2lwSnNFcnJvcnMsXG4gICAgICAgICAgICBkaXNhYmxlUGFnZVJlbG9hZHM6IGRpc2FibGVQYWdlUmVsb2FkcyxcbiAgICAgICAgICAgIHF1YXJhbnRpbmVNb2RlOiAgICAgcXVhcmFudGluZU1vZGUsXG4gICAgICAgICAgICBkZWJ1Z01vZGU6ICAgICAgICAgIGRlYnVnTW9kZSxcbiAgICAgICAgICAgIGRlYnVnT25GYWlsOiAgICAgICAgZGVidWdPbkZhaWwsXG4gICAgICAgICAgICBzZWxlY3RvclRpbWVvdXQ6ICAgIHNlbGVjdG9yVGltZW91dCxcbiAgICAgICAgICAgIGFzc2VydGlvblRpbWVvdXQ6ICAgYXNzZXJ0aW9uVGltZW91dCxcbiAgICAgICAgICAgIHBhZ2VMb2FkVGltZW91dDogICAgcGFnZUxvYWRUaW1lb3V0LFxuICAgICAgICAgICAgc3BlZWQ6ICAgICAgICAgICAgICBzcGVlZCxcbiAgICAgICAgICAgIHNraXBVbmNhdWdodEVycm9yczogc2tpcFVuY2F1Z2h0RXJyb3JzLFxuICAgICAgICAgICAgc3RvcE9uRmlyc3RGYWlsOiAgICBzdG9wT25GaXJzdEZhaWxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fc2V0Qm9vdHN0cmFwcGVyT3B0aW9ucygpO1xuXG4gICAgICAgIGNvbnN0IHJ1blRhc2tQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuX3ZhbGlkYXRlUnVuT3B0aW9ucygpKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uKCkpXG4gICAgICAgICAgICAudGhlbigoeyByZXBvcnRlclBsdWdpbnMsIGJyb3dzZXJTZXQsIHRlc3RzLCB0ZXN0ZWRBcHAgfSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9ydW5UYXNrKHJlcG9ydGVyUGx1Z2lucywgYnJvd3NlclNldCwgdGVzdHMsIHRlc3RlZEFwcCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fY3JlYXRlQ2FuY2VsYWJsZVByb21pc2UocnVuVGFza1Byb21pc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIHN0b3AgKCkge1xuICAgICAgICAvLyBOT1RFOiBXaGVuIHRhc2tQcm9taXNlIGlzIGNhbmNlbGxlZCwgaXQgaXMgcmVtb3ZlZCBmcm9tXG4gICAgICAgIC8vIHRoZSBwZW5kaW5nVGFza1Byb21pc2VzIGFycmF5LCB3aGljaCBsZWFkcyB0byBzaGlmdGluZyBpbmRleGVzXG4gICAgICAgIC8vIHRvd2FyZHMgdGhlIGJlZ2lubmluZy4gU28sIHdlIG11c3QgY29weSB0aGUgYXJyYXkgaW4gb3JkZXIgdG8gaXRlcmF0ZSBpdCxcbiAgICAgICAgLy8gb3Igd2UgY2FuIHBlcmZvcm0gaXRlcmF0aW9uIGZyb20gdGhlIGVuZCB0byB0aGUgYmVnaW5uaW5nLlxuICAgICAgICBjb25zdCBjYW5jZWxsYXRpb25Qcm9taXNlcyA9IG1hcFJldmVyc2UodGhpcy5wZW5kaW5nVGFza1Byb21pc2VzLCB0YXNrUHJvbWlzZSA9PiB0YXNrUHJvbWlzZS5jYW5jZWwoKSk7XG5cbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoY2FuY2VsbGF0aW9uUHJvbWlzZXMpO1xuICAgIH1cbn1cbiJdfQ==
